facet_wrap(~ line) +
theme_cowplot()
coi <- c("Docetaxel_DMSO", "DMSO_DMSO")
z_df <- ctg_loess %>%
filter(drug %in% coi) %>%
filter(!(drug == coi[1] & conc_1 %in% c(3:5))) %>%
group_by(id, drug, line, date) %>%
summarise(sd = sd(pcount_norm, na.rm = TRUE),
mean = mean(pcount_norm, na.rm = TRUE)) %>%
group_by(id, line, date) %>%
summarise(zfactor = 1-((3*sum(sd))/abs(range(mean)[1]-range(mean)[2]))) %>%
mutate(qc = if_else(zfactor < 0.25, FALSE, TRUE))
z_df %>%
arrange(zfactor) %>%
ungroup() %>%
mutate(id = factor(id, levels = id)) %>%
ggplot(aes(zfactor, id)) +
geom_point(aes(color =  line)) +
theme_cowplot()
# z_df_anno <- z_df %>% ungroup%>% mutate(id = paste0(id, "_", combination)) %>%
#   dplyr::select(-experiment, -zfactor) %>%
#   as.data.frame() %>%
#   remove_rownames() %>%
#   column_to_rownames("id")
#
# z_df %>% ungroup%>% mutate(id = paste0(id, "_", combination)) %>% dplyr::select(id, zfactor) %>%
#   arrange(zfactor) %>%
#   as.data.frame() %>%
#   remove_rownames() %>%
#   column_to_rownames("id") %>%
#   pheatmap(., cluster_cols = FALSE, annotation_row =  z_df_anno)
r <- ctg_loess %>%
mutate(ctrl = ifelse(drug == "DMSO", "negative", "none")) %>%
mutate(ctrl = ifelse(drug == "Docetaxel_DMSO" & conc_1 %in% c(1:2), "positive", ctrl)) %>%
#filter(drug %in% coi) %>%
unite(id, c("line", "well")) %>%
dplyr::select(id, pcount_norm, replicate) %>%
spread(replicate, pcount_norm) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`) %>%
dplyr::select(rep1, rep2) %>%
as.matrix() %>%
cor() %>%
.["rep1", "rep2"]
ctg_loess %>%
mutate(ctrl = ifelse(drug == "DMSO", "negative", "none")) %>%
mutate(ctrl = ifelse(drug == "Docetaxel_DMSO" & conc_1 %in% c(1:2), "positive", ctrl)) %>%
#filter(drug %in% coi) %>%
unite(id, c("line", "well")) %>%
dplyr::select(id, pcount_norm, replicate) %>%
spread(replicate, pcount_norm) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`) %>%
ggplot(aes(rep1, rep2)) +
geom_point(alpha = 0.2) +
#geom_point(alpha = 0.2, aes(color = ctrl)) +
#scale_color_manual(values=c("#E69F00", "#999999", "#56B4E9")) +
geom_abline(intercept = 0, slope = 1) +
#geom_hline(yintercept = 1) +
theme_classic() +
ggtitle(paste0("r (pearson) = ", r %>% round(2))) +
xlab("replicate 1") +
ylab("replicate 2") +
scale_y_continuous(breaks = c(0, 250000, 500000, 750000)) +
coord_fixed() +
ggsave("pearson_raw_valid.pdf", width = 4, height = 4)
r <- ctg_norm %>%
mutate(ctrl = ifelse(drug == "DMSO_DMSO", "negative", "none")) %>%
mutate(ctrl = ifelse(drug == "Docetaxel_DMSO" & conc_1 %in% c(1:2), "positive", ctrl)) %>%
#filter(drug %in% coi) %>%
unite(id, c("line", "well")) %>%
dplyr::select(id, viability, replicate) %>%
spread(replicate, viability) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`) %>%
dplyr::select(rep1, rep2) %>%
as.matrix() %>%
cor() %>%
.["rep1", "rep2"]
df <- ctg_norm %>%
mutate(ctrl = ifelse(drug == "DMSO", "negative", "none")) %>%
mutate(ctrl = ifelse(drug == "Docetaxel_DMSO" & conc_1 %in% c(1:2), "positive", ctrl)) %>%
#filter(drug %in% coi) %>%
unite(id, c("line", "well")) %>%
dplyr::select(id, viability_uncropped, replicate) %>%
spread(replicate, viability_uncropped) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`)
df %>% write_csv(here::here("results/plot_data/pearson_norm_valid.csv"))
df %>%
ggplot(aes(rep1, rep2)) +
geom_point(alpha = 0.2) +
#geom_point(alpha = 0.2, aes(color = ctrl)) +
#scale_color_manual(values=c("#E69F00", "#999999", "#56B4E9")) +
geom_abline(intercept = 0, slope = 1) +
#geom_hline(yintercept = 1) +
theme_classic() +
ggtitle(paste0("r (pearson) = ", r %>% round(2))) +
xlab("replicate 1") +
ylab("replicate 2") +
scale_y_continuous(breaks = c(0, 0.5, 1, 1.5,2)) +
scale_x_continuous(breaks = c(0, 0.5, 1, 1.5,2)) +
geom_hline(yintercept = 1) +
geom_vline(xintercept = 1) +
coord_fixed() +
ggsave("pearson_norm_valid.pdf", width = 4, height = 4)
ctg_norm %>%
dplyr::select(id, viability, well) %>%
spread(id, viability) %>%
dplyr::select(-well) %>%
as.matrix() %>%
cor() %>%
pheatmap::pheatmap()
ctg_norm <- ctg_norm %>%
mutate(viability = if_else(viability > 1, 1, viability))
f <- syn_table %>% filter(block_id == "Everolimus_AZD5363", line == "D013T01", replicate == 1) %>%
ungroup() %>%
dplyr::select(-replicate)
# trouble shooting
# me = c("ZIP", "HSA", "Bliss", "Loewe")
# m = me[1]
f
syn_table %>% filter(replicate ==1) %>%
mutate(conc_r = factor(conc_r),
conc_c = factor(conc_c)) %>%
ggplot(aes(conc_r, conc_c, fill = response)) +
geom_tile() +
scale_fill_viridis_c() +
facet_grid(block_id ~ line) +
theme_cowplot()+
ggsave("response_overview.pdf", height = 15, width = 17)
# syn_table shows the missing data
syn_table %>%
group_by(block_id) %>%
summarise(n = n()) %>%
filter(n != max(n))
# ctg_norm is not ok
ctg_data %>%
mutate(block_id = paste(drug, sep = "_")) %>%
group_by(block_id) %>%
summarise(n = n()) %>%
count(n)
# I filter n = 130, 104, 416
ctg_data %>%
mutate(block_id = paste(drug, sep = "_")) %>%
group_by(block_id) %>%
summarise(n = n()) %>%
filter(n %in% c(364, 104, 416))
read_csv(here("anno/combi_validation_robot.csv")) %>%
separate(drug_pair_conc, c("drug_1", "drug_2", "conc_1", "conc_2"),
remove = FALSE, sep = "_") %>%
mutate(block_id = paste(drug, sep = "_")) %>%
group_by(block_id) %>%
summarise(n = n())
syn_shape <- syn_table %>%
nest(-line, -replicate) %>%
mutate(reshaped = map(data, ~ ReshapeData(.x,
data.type = "viability",
impute = TRUE,
noise = TRUE,
correction = "all")))
coi <- c("DMSO")
ctg_loess %>%
mutate(date = as.character(date)) %>%
filter(drug_1 %in% coi & drug_2 %in% coi) %>%
ggplot(aes(line, pcount_norm, color = date)) +
#geom_violin(aes(group = drug)) +
geom_jitter(alpha = 0.7, width = 0.1) +
#geom_boxplot(width = 30) +
#facet_wrap(~line) +
theme_cowplot() +
coord_flip()
# ctg_loess %>%
#   mutate(line_date_exp = paste0(line, "_", date)) %>%
#   filter(drug %in% coi) %>%
#   filter(combination == TRUE) %>%
#   ggplot(aes(id, pcount_norm, color = drug)) +
#   #geom_violin(aes(group = drug)) +
#   geom_boxplot(alpha = 0.7) +
#   #facet_grid(line_date_exp ~ Library) +
#   #facet_wrap(~line) +
#   theme_classic()
order <- syn_scores %>%
filter(line != "D093N11") %>%
group_by(block_id) %>%
summarise(mean = mean(score_average)) %>%
arrange(mean) %>%
.$block_id
syn_scores
load("~/github/tas/syn_table_targeted_complete_valid.Rdata")
order <- syn_scores %>%
filter(line != "D093N11") %>%
group_by(block_id) %>%
summarise(mean = mean(score_average)) %>%
arrange(mean) %>%
.$block_id
syn_scores
load("~/github/tas/syn_table_targeted_complete_valid.Rdata")
syn_table
syn_table <- read_csv(here::here("data/processed/synergy_input.csv"))
syn_table
load("~/github/tas/vignettes/syn_scores_targeted_complete_valid.Rdata")
View(syn_scores)
syn_scores %>% write_csv(here::here("data/processed/synergy_scores.csv"))
syn_scores <- read_csv(here::here("data/processed/synergy_scores.csv"))
syn_scores <- read_csv(here::here("data/processed/synergy_scores.csv"))
order <- syn_scores %>%
filter(line != "D093N11") %>%
group_by(block_id) %>%
summarise(mean = mean(score_average)) %>%
arrange(mean) %>%
.$block_id
syn_scores %>%
filter(line != "D093N11") %>%
mutate(block_id = factor(block_id, levels = order)) %>%
ggplot(aes(score_average, block_id, color = line)) +
geom_vline(xintercept = 0) +
geom_jitter(height = 0.1, width = 0.1) +
facet_wrap(~ method ) +
theme_cowplot() +
scale_colour_brewer(type = "qual", palette = 3)
r <- syn_scores %>%
filter(line != "D093N11") %>%
mutate(id = paste(block_id, line, method, sep = "_")) %>%
dplyr::select(replicate, score_average, id) %>%
tidyr::spread(replicate, score_average) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`) %>%
dplyr::select(rep1, rep2) %>%
as.matrix() %>%
cor(method = "spearman") %>%
.["rep1", "rep2"]
df <- syn_scores %>%
filter(line != "D093N11") %>%
mutate(id = paste(block_id, line, method, sep = "_")) %>%
dplyr::select(replicate, score_average, id) %>%
tidyr::spread(replicate, score_average) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`)
df %>% write_csv(here::here("results/plot_data/correlation_synergy.csv"))
df %>%
ggplot(aes(rep1, rep2)) +
geom_point(alpha = 0.2) +
#geom_point(alpha = 0.2, aes(color = ctrl)) +
#scale_color_manual(values=c("#E69F00", "#999999", "#56B4E9")) +
geom_abline(intercept = 0, slope = 1) +
#geom_hline(yintercept = 1) +
theme_classic() +
ggtitle(paste0("r (spearman) = ", r %>% round(2))) +
xlab("replicate 1") +
ylab("replicate 2") +
coord_fixed() +
ggsave("correlation_synergy.pdf", width = 4, height = 4)
r <- syn_scores %>%
filter(line != "D093N11") %>%
mutate(id = paste(block_id, line, method, sep = "_")) %>%
dplyr::select(replicate, score_average, id) %>%
tidyr::spread(replicate, score_average) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`) %>%
dplyr::select(rep1, rep2) %>%
as.matrix() %>%
cor(method = "spearman") %>%
.["rep1", "rep2"]
df <- syn_scores %>%
filter(line != "D093N11") %>%
mutate(id = paste(block_id, line, method, sep = "_")) %>%
dplyr::select(replicate, score_average, id) %>%
tidyr::spread(replicate, score_average) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`)
df %>% write_csv(here::here("results/plot_data/correlation_synergy.csv"))
df %>%
ggplot(aes(rep1, rep2)) +
geom_point(alpha = 0.2) +
#geom_point(alpha = 0.2, aes(color = ctrl)) +
#scale_color_manual(values=c("#E69F00", "#999999", "#56B4E9")) +
geom_abline(intercept = 0, slope = 1) +
#geom_hline(yintercept = 1) +
theme_classic() +
ggtitle(paste0("r (spearman) = ", r %>% round(2))) +
xlab("replicate 1") +
ylab("replicate 2") +
coord_fixed() +
ggsave(here::here("reports/figures/correlation_synergy.pdf"), width = 4, height = 4)
r <- syn_scores %>%
filter(line != "D093N11") %>%
mutate(id = paste(block_id, line, method, sep = "_")) %>%
dplyr::select(replicate, score_average, id) %>%
tidyr::spread(replicate, score_average) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`) %>%
dplyr::select(rep1, rep2) %>%
as.matrix() %>%
cor(method = "spearman") %>%
.["rep1", "rep2"]
df <- syn_scores %>%
filter(line != "D093N11") %>%
mutate(id = paste(block_id, line, method, sep = "_")) %>%
dplyr::select(replicate, score_average, id) %>%
tidyr::spread(replicate, score_average) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`)
df %>% write_csv(here::here("reports/plot_data/correlation_synergy.csv"))
df %>% write_csv(here::here("reports/plot_data/correlation_synergy.csv"))
df %>%
ggplot(aes(rep1, rep2)) +
geom_point(alpha = 0.2) +
#geom_point(alpha = 0.2, aes(color = ctrl)) +
#scale_color_manual(values=c("#E69F00", "#999999", "#56B4E9")) +
geom_abline(intercept = 0, slope = 1) +
#geom_hline(yintercept = 1) +
theme_classic() +
ggtitle(paste0("r (spearman) = ", r %>% round(2))) +
xlab("replicate 1") +
ylab("replicate 2") +
coord_fixed() +
ggsave(here::here("reports/figures/correlation_synergy.pdf"), width = 4, height = 4)
order_line <- syn_scores %>%
filter(line != "D093N11") %>%
group_by(line) %>%
summarise(mean = mean(score_average)) %>%
arrange(mean) %>%
.$line
syn_scores %>%
filter(line != "D093N11") %>%
mutate(line = factor(line, levels = order_line)) %>%
ggplot(aes(score_average, line, color = block_id)) +
geom_vline(xintercept = 0) +
geom_jitter(height = 0.1, width = 0.1) +
facet_wrap(~ method ) +
theme_cowplot() +
scale_colour_brewer(type = "qual", palette = 3)
syn_collapsed <- syn_scores %>%
filter(line != "D093N11") %>%
group_by(block_id, method, line) %>%
summarise(score = mean(score_average))
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "ZIP")) %>% summary()
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "Bliss")) %>% summary()
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "Loewe")) %>% summary()
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "HSA")) %>% summary()
lm(score ~ block_id + method, data = syn_collapsed) %>% summary()
syn_collapsed %>%
ungroup() %>%
filter(method == "ZIP") %>%
dplyr::select(line, score, block_id, -method) %>%
spread(line, score) %>%
as.data.frame() %>%
column_to_rownames("block_id") %>%
pheatmap::pheatmap()
syn_collapsed
syn_collapsed <- syn_scores %>%
filter(line != "D093N11") %>%
filter(block_id != "Vorinostat_EHMT-Inh.") %>%
group_by(block_id, method, line) %>%
summarise(score = mean(score_average))
syn_collapsed %>% write_csv(here("data/processed/synergy_simplified.csv"))
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "ZIP")) %>% summary()
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "Bliss")) %>% summary()
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "Loewe")) %>% summary()
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "HSA")) %>% summary()
lm(score ~ block_id + method, data = syn_collapsed) %>% summary()
syn_collapsed <- syn_scores %>%
filter(line != "D093N11") %>%
filter(block_id != "Vorinostat_EHMT-Inh.") %>%
group_by(block_id, method, line) %>%
summarise(score = mean(score_average))
syn_collapsed %>% write_csv(here("data/processed/synergy_simplified.csv"))
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "ZIP")) %>% summary()
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "Bliss")) %>% summary()
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "Loewe")) %>% summary()
# lm(score ~ block_id, data = syn_collapsed %>% filter(method == "HSA")) %>% summary()
lm(score ~ block_id + method, data = syn_collapsed) %>% summary()
syn_collapsed %>%
ungroup() %>%
filter(method == "ZIP") %>%
dplyr::select(line, score, block_id, -method) %>%
spread(line, score) %>%
as.data.frame() %>%
column_to_rownames("block_id") %>%
pheatmap::pheatmap()
?pheatmap
syn_collapsed %>%
ungroup() %>%
filter(method == "ZIP") %>%
dplyr::select(line, score, block_id, -method) %>%
spread(line, score) %>%
as.data.frame() %>%
column_to_rownames("block_id") %>%
pheatmap::pheatmap(filename = here::here("reports/figures/heatmap_zip_line.pdf"))
lm(score ~ block_id + method, data = syn_collapsed %>% filter(line != "D093N11")) %>% broom::tidy() %>%
mutate(q = p.adjust(p.value, method = "bonferroni")) %>%
filter(q < 0.05, grepl(pattern = "block", x = term)) %>%
mutate(term = substr(term, 9, nchar(term))) %>%
arrange(desc(estimate))
syn_collapsed %>%
ungroup() %>%
filter(line != "D093N11") %>%
mutate(block_id = factor(block_id, levels = order)) %>%
ggplot(aes(score, block_id, color = line)) +
geom_vline(xintercept = 0) +
geom_jitter(height = 0.1, width = 0.1) +
facet_wrap(~ method ) +
theme_cowplot() +
scale_colour_brewer(type = "qual", palette = 3)
model_estimate <- lm(score ~ block_id + method, data = syn_collapsed %>% filter(line != "D093N11")) %>% broom::tidy() %>%
mutate(q = p.adjust(p.value, method = "bonferroni")) %>%
filter(q < 0.05, grepl(pattern = "block", x = term)) %>%
mutate(term = substr(term, 9, nchar(term))) %>%
arrange(desc(estimate))
model_estimate
set.seed(1234)
model_estimate <- lm(score ~ block_id + method, data = syn_collapsed %>% filter(line != "D093N11")) %>% broom::tidy() %>%
mutate(q = p.adjust(p.value, method = "bonferroni")) %>%
filter(q < 0.05, grepl(pattern = "block", x = term)) %>%
mutate(term = substr(term, 9, nchar(term))) %>%
arrange(desc(estimate))
model_estimate %>% write_csv(here::here("reports/tables/lm_synergy.csv"))
model_estimate
syn_collapsed %>%
ungroup() %>%
filter(line != "D093N11") %>%
mutate(block_id = factor(block_id, levels = order)) %>%
ggplot(aes(score, block_id, color = line)) +
geom_vline(xintercept = 0) +
geom_jitter(height = 0.1, width = 0.1) +
facet_wrap(~ method ) +
theme_cowplot() +
scale_colour_brewer(type = "qual", palette = 3) +
coord_fixed() +
ggsave(here::here("reports/figures/synergy_line.pdf"))
syn_collapsed %>%
ungroup() %>%
filter(line != "D093N11") %>%
mutate(block_id = factor(block_id, levels = order)) %>%
ggplot(aes(score, block_id, color = line)) +
geom_vline(xintercept = 0) +
geom_jitter(height = 0.1, width = 0.1) +
facet_wrap(~ method ) +
theme_cowplot() +
scale_colour_brewer(type = "qual", palette = 3) +
coord_fixed() +
ggsave(here::here("reports/figures/synergy_line.pdf"))
syn_collapsed %>%
ungroup() %>%
filter(line != "D093N11") %>%
mutate(block_id = factor(block_id, levels = order)) %>%
ggplot(aes(score, block_id, color = line)) +
geom_vline(xintercept = 0) +
geom_jitter(height = 0.1, width = 0.1) +
facet_wrap(~ method ) +
theme_cowplot() +
scale_colour_brewer(type = "qual", palette = 3) +
ggsave(here::here("reports/figures/synergy_line.pdf"))
r <- ctg_loess %>%
mutate(ctrl = ifelse(drug == "DMSO", "negative", "none")) %>%
mutate(ctrl = ifelse(drug == "Docetaxel_DMSO" & conc_1 %in% c(1:2), "positive", ctrl)) %>%
#filter(drug %in% coi) %>%
unite(id, c("line", "well")) %>%
dplyr::select(id, pcount_norm, replicate) %>%
spread(replicate, pcount_norm) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`) %>%
dplyr::select(rep1, rep2) %>%
as.matrix() %>%
cor() %>%
.["rep1", "rep2"]
ctg_loess <- read_csv(here::here("data/processed/ctg_loess.csv"))
#source(here::here("src/data/make_ctg_data.R"))
#source(here::here("src/data/"))
ctg_data <- read_csv(here::here("data/processed/ctg_data.csv"))
ctg_loess <- read_csv(here::here("data/processed/ctg_loess.csv"))
ctg_norm <- read_csv(here::here("data/processed/ctg_norm.csv"))
syn_table <- read_csv(here::here("data/processed/synergy_input.csv"))
syn_scores <- read_csv(here::here("data/processed/synergy_scores.csv"))
r <- ctg_loess %>%
mutate(ctrl = ifelse(drug == "DMSO", "negative", "none")) %>%
mutate(ctrl = ifelse(drug == "Docetaxel_DMSO" & conc_1 %in% c(1:2), "positive", ctrl)) %>%
#filter(drug %in% coi) %>%
unite(id, c("line", "well")) %>%
dplyr::select(id, pcount_norm, replicate) %>%
spread(replicate, pcount_norm) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`) %>%
dplyr::select(rep1, rep2) %>%
as.matrix() %>%
cor() %>%
.["rep1", "rep2"]
df <- ctg_loess %>%
mutate(ctrl = ifelse(drug == "DMSO", "negative", "none")) %>%
mutate(ctrl = ifelse(drug == "Docetaxel_DMSO" & conc_1 %in% c(1:2), "positive", ctrl)) %>%
#filter(drug %in% coi) %>%
unite(id, c("line", "well")) %>%
dplyr::select(id, pcount_norm, replicate) %>%
spread(replicate, pcount_norm) %>%
rename(rep1 = `1`) %>%
rename(rep2 = `2`)
df  %>% write_csv(here::here("reports/plot_data/pearson_raw_valid.csv"))
df %>%
ggplot(aes(rep1, rep2)) +
geom_point(alpha = 0.2) +
#geom_point(alpha = 0.2, aes(color = ctrl)) +
#scale_color_manual(values=c("#E69F00", "#999999", "#56B4E9")) +
geom_abline(intercept = 0, slope = 1) +
#geom_hline(yintercept = 1) +
theme_classic() +
ggtitle(paste0("r (pearson) = ", r %>% round(2))) +
xlab("replicate 1") +
ylab("replicate 2") +
scale_y_continuous(breaks = c(0, 250000, 500000, 750000)) +
coord_fixed() +
ggsave(here::here("reports/figures/pearson_raw_valid.pdf"), width = 4, height = 4)
